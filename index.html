<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å¥åº·ç”Ÿæ´» OS v2.0</title>
    <style>
        /* --- å…¨å±€ç³»ç»Ÿæ ·å¼ --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            --phone-bg: #1a1a2e;
            --app-header-bg: rgba(26, 26, 46, 0.95);
            --text-color: #e0e0e0;
            --glass-card: rgba(255, 255, 255, 0.05);
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* App ä¸»é¢˜è‰² */
            --sleep-color: #a855f7;
            --poop-color: #d97706;
            --period-color: #fb7185; /* ç«ç‘°ç²‰ */
            --period-bg-gradient: linear-gradient(135deg, #881337, #be123c);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .phone-screen {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 880px;
            background-color: var(--phone-bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: var(--phone-bg);
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* --- Header --- */
        .app-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            padding-top: max(15px, env(safe-area-inset-top));
            background-color: var(--app-header-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding-right: 15px; }
        .header-title { font-size: 18px; font-weight: 600; color: white; flex-grow: 1; text-align: center; margin-right: 24px; }

        /* --- Home Screen --- */
        #home-screen {
            background: linear-gradient(to bottom, #0f172a, #334155);
            padding: 40px 20px;
            align-items: center;
        }
        .home-clock { margin-top: 60px; text-align: center; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .home-time { font-size: 4rem; font-weight: 200; line-height: 1; }
        .home-date { font-size: 1.2rem; margin-top: 10px; opacity: 0.8; }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3åˆ—å¸ƒå±€ */
            gap: 20px;
            margin-top: 60px;
            width: 100%;
        }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .app-icon:active { transform: scale(0.9); }
        .icon-box {
            width: 65px; height: 65px; border-radius: 18px;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); margin-bottom: 8px;
        }
        .icon-sleep { background: linear-gradient(135deg, #6366f1, #a855f7); }
        .icon-poop { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .icon-period { background: linear-gradient(135deg, #f43f5e, #fb7185); } /* æ–°å›¾æ ‡é¢œè‰² */
        .app-name { color: white; font-size: 12px; }

        /* --- Components --- */
        .content-container { padding: 20px; padding-bottom: 80px; }
        .card {
            background: var(--glass-card); border-radius: 20px; padding: 20px;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }
        .btn-main {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 16px; font-weight: bold; color: white; cursor: pointer;
            margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }
        input, textarea, select {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 10px; border-radius: 10px; width: 100%; font-family: inherit;
        }

        /* --- Calendar --- */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: white; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-cell {
            aspect-ratio: 1; display: flex; justify-content: center; align-items: center;
            border-radius: 8px; font-size: 12px; color: #64748b; position: relative; cursor: pointer;
        }
        .cal-cell.today { border: 1px solid white; color: white; font-weight: bold; }

        /* Sleep Styles */
        .sleep-gold { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .sleep-silver { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }

        /* Poop Styles */
        .poop-dot { width: 6px; height: 6px; background: #d97706; border-radius: 50%; position: absolute; bottom: 4px; }
        .poop-types { display: flex; justify-content: space-between; margin-bottom: 10px; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 5px; }
        .type-option { flex: 1; text-align: center; padding: 10px 5px; border-radius: 12px; opacity: 0.5; font-size: 20px; }
        .type-option.selected { background: rgba(255,255,255,0.1); opacity: 1; }

        /* Period Styles */
        .period-dashboard {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px 0;
        }
        .cycle-circle {
            width: 160px; height: 160px; border-radius: 50%;
            border: 6px solid rgba(251, 113, 133, 0.2);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 15px; position: relative;
        }
        .cycle-circle.active { border-color: var(--period-color); box-shadow: 0 0 20px rgba(251, 113, 133, 0.3); }
        .cycle-day-num { font-size: 3rem; font-weight: bold; color: white; line-height: 1; }
        .cycle-day-label { font-size: 0.9rem; color: #fda4af; margin-top: 5px; }
        
        .period-tags { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .p-tag { 
            padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); 
            color: #ddd; font-size: 12px; white-space: nowrap; cursor: pointer; border: 1px solid transparent;
        }
        .p-tag.selected { background: rgba(251, 113, 133, 0.2); border-color: var(--period-color); color: white; }

        /* ç»æœŸæ—¥å†é¢œè‰² */
        .cal-cell.period-flow { background-color: #fb7185; color: white; } /* å®å¿ƒç²‰ */
        .cal-cell.period-predicted { border: 1px dashed #fb7185; color: #fb7185; } /* è™šçº¿æ¡†é¢„æµ‹ */
        .cal-cell.period-ovulation { background-color: rgba(167, 139, 250, 0.2); color: #a78bfa; } /* æ’åµæœŸç´« */

        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; color: #ddd; }
        .settings-row input { width: 60px; text-align: center; padding: 5px; }

    </style>
</head>
<body>

<div class="phone-screen">
    
    <div id="home-screen" class="screen active">
        <div class="home-clock">
            <div class="home-time" id="sys-time">12:00</div>
            <div class="home-date" id="sys-date">--æœˆ--æ—¥</div>
        </div>

        <div class="app-grid">
            <div class="app-icon" onclick="openApp('sleep-app')">
                <div class="icon-box icon-sleep">ğŸŒ™</div>
                <span class="app-name">æ—©ç¡</span>
            </div>
            <div class="app-icon" onclick="openApp('poop-app')">
                <div class="icon-box icon-poop">ğŸ’©</div>
                <span class="app-name">ä¾¿ä¾¿</span>
            </div>
            <div class="app-icon" onclick="openApp('period-app')">
                <div class="icon-box icon-period">ğŸ©¸</div>
                <span class="app-name">ç»æœŸåŠ©æ‰‹</span>
            </div>
        </div>
    </div>

    <div id="sleep-app" class="screen">
        <header class="app-header">
            <button class="back-btn" onclick="goHome()">â€¹</button>
            <div class="header-title">æ—©ç¡æ‰“å¡</div>
        </header>
        <div class="content-container">
            <div class="card" style="text-align: center;">
                <div style="font-size: 3rem; font-weight: bold; color: white;" id="sleep-clock">00:00</div>
                <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 10px; display: inline-flex; align-items: center; gap: 10px; margin-top:10px;">
                    <span style="font-size:12px; color:#aaa;">ç›®æ ‡:</span>
                    <input type="time" id="sleep-target-time" value="23:00" onchange="saveSleepSettings()" style="border:none; background:transparent; padding:0; width:auto; color:white;">
                </div>
            </div>
            <div class="card" id="sleep-action-area">
                <button id="sleep-btn" class="btn-main" style="background: linear-gradient(90deg, #7c3aed, #db2777);" onclick="handleSleepCheckIn()">æ‰“å¡ç¡è§‰ ğŸ’¤</button>
            </div>
            <div class="card" id="sleep-status-area" style="display: none; text-align: center;">
                <h3 style="color: #4ade80; margin:0;">ä»Šæ—¥å·²å®Œæˆ âœ…</h3>
                <p style="color: #aaa; font-size: 0.9rem;">æ‰“å¡æ—¶é—´: <span id="sleep-done-time" style="color:white;"></span></p>
            </div>
            <div class="card">
                <div class="cal-header"><span>æ‰“å¡è®°å½•</span></div>
                <div class="cal-grid" id="sleep-cal-grid"></div>
            </div>
        </div>
    </div>

    <div id="poop-app" class="screen">
        <header class="app-header">
            <button class="back-btn" onclick="goHome()">â€¹</button>
            <div class="header-title">ä¾¿ä¾¿æ—¥è®°</div>
        </header>
        <div class="content-container">
            <div class="card">
                <div style="text-align:center; color:#888; margin-bottom:5px;">ä»Šæ—¥æ¬¡æ•°</div>
                <div style="font-size: 2.5rem; font-weight: bold; color: white; text-align: center;" id="poop-today-count">0</div>
            </div>
            <div class="card">
                <div class="poop-types">
                    <div class="type-option" onclick="selectPoopType(1)" data-val="1">ğŸª¨</div>
                    <div class="type-option selected" onclick="selectPoopType(2)" data-val="2">ğŸŒ</div>
                    <div class="type-option" onclick="selectPoopType(3)" data-val="3">ğŸ¦</div>
                    <div class="type-option" onclick="selectPoopType(4)" data-val="4">ğŸŒŠ</div>
                </div>
                <button class="btn-main" style="background: linear-gradient(90deg, #d97706, #f59e0b);" onclick="handlePoopCheckIn()">æ‰“å¡ ğŸ§»</button>
            </div>
            <div class="card">
                <div class="cal-header"><span>æ’ä¾¿æ—¥å†</span></div>
                <div class="cal-grid" id="poop-cal-grid"></div>
            </div>
        </div>
    </div>

    <div id="period-app" class="screen">
        <header class="app-header">
            <button class="back-btn" onclick="goHome()">â€¹</button>
            <div class="header-title">ç»æœŸåŠ©æ‰‹</div>
        </header>
        <div class="content-container">
            
            <div class="period-dashboard">
                <div class="cycle-circle" id="cycle-circle">
                    <div class="cycle-day-num" id="cycle-main-text">--</div>
                    <div class="cycle-day-label" id="cycle-sub-text">ç­‰å¾…è®°å½•</div>
                </div>
                <div style="color: #aaa; font-size: 0.9rem;">
                    é¢„è®¡ä¸‹æ¬¡: <span id="next-period-date" style="color: white; font-weight:bold;">--æœˆ--æ—¥</span>
                </div>
            </div>

            <div class="card">
                <div style="color: white; margin-bottom: 10px; font-size:0.9rem;">ä»Šæ—¥çŠ¶æ€ (ç‚¹å‡»é€‰æ‹©)</div>
                
                <div style="font-size:12px; color:#888; margin-bottom:5px;">ç»é‡:</div>
                <div class="period-tags" id="flow-tags">
                    <div class="p-tag" onclick="togglePeriodTag('flow', 'light')">ğŸ’§ å°‘é‡</div>
                    <div class="p-tag" onclick="togglePeriodTag('flow', 'medium')">ğŸ’§ğŸ’§ ä¸­ç­‰</div>
                    <div class="p-tag" onclick="togglePeriodTag('flow', 'heavy')">ğŸ’§ğŸ’§ğŸ’§ å¤§é‡</div>
                </div>

                <div style="font-size:12px; color:#888; margin-bottom:5px;">ç—›æ„Ÿ:</div>
                <div class="period-tags" id="pain-tags">
                    <div class="p-tag" onclick="togglePeriodTag('pain', 'none')">ğŸ˜Š æ— ç—›</div>
                    <div class="p-tag" onclick="togglePeriodTag('pain', 'mild')">ğŸ˜ è½»å¾®</div>
                    <div class="p-tag" onclick="togglePeriodTag('pain', 'severe')">ğŸ˜« å‰§çƒˆ</div>
                </div>

                <button class="btn-main" style="background: linear-gradient(135deg, #f43f5e, #e11d48);" onclick="togglePeriodToday()">
                    <span id="period-action-btn-text">å¤§å§¨å¦ˆæ¥äº†</span>
                </button>
                <div style="text-align:center; margin-top:10px; font-size:12px; color:#666;">æç¤ºï¼šä¹Ÿå¯ä»¥ç›´æ¥ç‚¹å‡»æ—¥å†è¡¥å½•</div>
            </div>

            <div class="card">
                <div class="cal-header">
                    <button class="back-btn" style="font-size:16px;" onclick="changePeriodMonth(-1)">â®</button>
                    <span id="period-cal-title">2025å¹´ 11æœˆ</span>
                    <button class="back-btn" style="font-size:16px;" onclick="changePeriodMonth(1)">â¯</button>
                </div>
                <div class="cal-grid" id="period-cal-grid"></div>
                <div style="margin-top:10px; font-size: 10px; color: #888; display: flex; gap: 10px; justify-content: center;">
                    <span><span style="color:#fb7185">â– </span> ç»æœŸ</span>
                    <span><span style="border:1px dashed #fb7185; padding:0 2px;">â–¡</span> é¢„æµ‹</span>
                    <span><span style="color:#a78bfa">â– </span> æ’åµæœŸ</span>
                </div>
            </div>

            <div class="card">
                <div style="color:white; margin-bottom:15px; font-weight:bold;">å‘¨æœŸè®¾ç½®</div>
                <div class="settings-row">
                    <span>ç»æœŸé•¿åº¦ (å¤©)</span>
                    <input type="number" id="setting-period-len" value="5" onchange="savePeriodSettings()">
                </div>
                <div class="settings-row">
                    <span>å‘¨æœŸé•¿åº¦ (å¤©)</span>
                    <input type="number" id="setting-cycle-len" value="28" onchange="savePeriodSettings()">
                </div>
            </div>

        </div>
    </div>

</div>

<script>
    // --- Global Utils ---
    const getTodayStr = () => new Date().toISOString().split('T')[0];
    const formatTime = (ts) => new Date(ts).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
    
    // --- Navigation ---
    function openApp(appId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(appId).classList.add('active');
        if (appId === 'sleep-app') renderSleepUI();
        if (appId === 'poop-app') renderPoopUI();
        if (appId === 'period-app') renderPeriodUI();
    }
    function goHome() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('home-screen').classList.add('active');
    }
    function updateSysClock() {
        const now = new Date();
        const t = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
        const d = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'});
        document.getElementById('sys-time').innerText = t;
        document.getElementById('sys-date').innerText = d;
        if(document.getElementById('sleep-clock')) document.getElementById('sleep-clock').innerText = t;
    }
    setInterval(updateSysClock, 1000); updateSysClock();

    // ==========================
    // ğŸŒ™ App 1: Sleep Logic (Same)
    // ==========================
    const SLEEP_KEY = 'sleep_data_v3';
    const SLEEP_SETTING = 'sleep_settings_v3';
    function getSleepData(){return JSON.parse(localStorage.getItem(SLEEP_KEY)||'[]')}
    function saveSleepSettings(){localStorage.setItem(SLEEP_SETTING, document.getElementById('sleep-target-time').value); renderSleepUI();}
    function handleSleepCheckIn(){
        const r=getSleepData(), t=getTodayStr();
        if(r.some(x=>x.date===t))return alert("ä»Šæ—¥å·²æ‰“å¡");
        r.unshift({date:t, time:formatTime(new Date()), timestamp:Date.now()});
        localStorage.setItem(SLEEP_KEY, JSON.stringify(r)); renderSleepUI();
    }
    function renderSleepUI(){
        const r=getSleepData(), t=getTodayStr(), tgt=localStorage.getItem(SLEEP_SETTING)||'23:00';
        document.getElementById('sleep-target-time').value=tgt;
        const tr=r.find(x=>x.date===t);
        document.getElementById('sleep-action-area').style.display=tr?'none':'block';
        document.getElementById('sleep-status-area').style.display=tr?'block':'none';
        if(tr)document.getElementById('sleep-done-time').innerText=tr.time;
        
        const g=document.getElementById('sleep-cal-grid'); g.innerHTML='';
        const n=new Date(), days=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();
        for(let i=1;i<=days;i++){
            const d=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const c=document.createElement('div'); c.className='cal-cell'; c.innerText=i;
            if(d===t)c.classList.add('today');
            const rec=r.find(x=>x.date===d);
            if(rec) c.classList.add(rec.time<=tgt?'sleep-gold':'sleep-silver');
            g.appendChild(c);
        }
    }

    // ==========================
    // ğŸ’© App 2: Poop Logic (Same)
    // ==========================
    const POOP_KEY = 'poop_data_v1';
    let curPoopType=2;
    function getPoopData(){return JSON.parse(localStorage.getItem(POOP_KEY)||'[]')}
    function selectPoopType(t){
        curPoopType=t; document.querySelectorAll('#poop-app .type-option').forEach(e=>e.classList.remove('selected'));
        document.querySelector(`#poop-app .type-option[data-val="${t}"]`).classList.add('selected');
    }
    function handlePoopCheckIn(){
        const r=getPoopData();
        r.unshift({date:getTodayStr(), type:curPoopType});
        localStorage.setItem(POOP_KEY, JSON.stringify(r)); renderPoopUI(); alert("è®°å½•æˆåŠŸ!");
    }
    function renderPoopUI(){
        const r=getPoopData(), t=getTodayStr();
        document.getElementById('poop-today-count').innerText = r.filter(x=>x.date===t).length;
        const g=document.getElementById('poop-cal-grid'); g.innerHTML='';
        const n=new Date(), days=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();
        for(let i=1;i<=days;i++){
            const d=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const c=document.createElement('div'); c.className='cal-cell'; c.innerText=i;
            if(d===t)c.classList.add('today');
            if(r.some(x=>x.date===d)){
                const dot=document.createElement('div'); dot.className='poop-dot'; c.appendChild(dot);
            }
            g.appendChild(c);
        }
    }

    // ==========================
    // ğŸ©¸ App 3: Period Logic (NEW)
    // ==========================
    const PERIOD_KEY = 'period_data_v1';
    const PERIOD_SETTINGS_KEY = 'period_settings_v1';
    let periodViewDate = new Date();
    let currentPeriodTags = { flow: null, pain: null };

    function getPeriodData() { return JSON.parse(localStorage.getItem(PERIOD_KEY) || '[]'); } // [{date: 'YYYY-MM-DD', flow: '..', pain: '..'}]
    function savePeriodData(data) { localStorage.setItem(PERIOD_KEY, JSON.stringify(data)); }
    
    function getPeriodSettings() {
        const s = JSON.parse(localStorage.getItem(PERIOD_SETTINGS_KEY) || '{}');
        return { cycleLen: parseInt(s.cycleLen)||28, periodLen: parseInt(s.periodLen)||5 };
    }
    function savePeriodSettings() {
        const s = {
            cycleLen: document.getElementById('setting-cycle-len').value,
            periodLen: document.getElementById('setting-period-len').value
        };
        localStorage.setItem(PERIOD_SETTINGS_KEY, JSON.stringify(s));
        renderPeriodUI();
    }

    function togglePeriodTag(type, val) {
        currentPeriodTags[type] = (currentPeriodTags[type] === val) ? null : val;
        // æ›´æ–° UI
        document.querySelectorAll(`#${type}-tags .p-tag`).forEach(el => el.classList.remove('selected'));
        if (currentPeriodTags[type]) {
            // ç®€å•çš„æ–‡æœ¬åŒ¹é…æ¥é«˜äº®ï¼Œå®é™…é¡¹ç›®å¯ä»¥ç”¨ data-attribute
            const tags = document.getElementById(`${type}-tags`).children;
            for(let tag of tags) {
                if(tag.innerText.includes(val === 'heavy' ? 'å¤§é‡' : val === 'medium' ? 'ä¸­ç­‰' : val === 'light' ? 'å°‘é‡' : val === 'severe' ? 'å‰§çƒˆ' : val === 'mild' ? 'è½»å¾®' : 'æ— ç—›')) {
                    tag.classList.add('selected');
                }
            }
        }
    }

    // æ ¸å¿ƒï¼šç‚¹å‡»"å¤§å§¨å¦ˆæ¥äº†"æˆ–"ç»“æŸ"
    function togglePeriodToday() {
        const today = getTodayStr();
        let data = getPeriodData();
        const existingIndex = data.findIndex(d => d.date === today);
        
        if (existingIndex > -1) {
            // å¦‚æœå·²ç»æœ‰è®°å½•ï¼Œå†æ¬¡ç‚¹å‡»åˆ™åˆ é™¤ï¼ˆå–æ¶ˆï¼‰
            if(confirm("ä»Šå¤©å·²è®°å½•ç»æœŸï¼Œè¦å–æ¶ˆå—ï¼Ÿ")) {
                data.splice(existingIndex, 1);
            }
        } else {
            // æ–°å¢è®°å½•
            data.push({
                date: today,
                flow: currentPeriodTags.flow,
                pain: currentPeriodTags.pain
            });
        }
        savePeriodData(data);
        renderPeriodUI();
    }

    // æ ¸å¿ƒï¼šç‚¹å‡»æ—¥å†æ ¼å­è¡¥å½•/å–æ¶ˆ
    function togglePeriodDate(dateStr) {
        let data = getPeriodData();
        const index = data.findIndex(d => d.date === dateStr);
        if (index > -1) {
            data.splice(index, 1); // åˆ é™¤
        } else {
            data.push({ date: dateStr }); // å¢åŠ 
        }
        savePeriodData(data);
        renderPeriodUI();
    }

    function changePeriodMonth(offset) {
        periodViewDate.setMonth(periodViewDate.getMonth() + offset);
        renderPeriodUI();
    }

    // é¢„æµ‹é€»è¾‘
    function calculateCyclePredictions(data, settings) {
        if (data.length === 0) return { nextPeriod: null, predictedDays: [] };

        // 1. æ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡ç»æœŸå¼€å§‹æ—¶é—´
        // ç®€å•ç®—æ³•ï¼šå¯¹æ—¥æœŸæ’åºï¼Œæ‰¾åˆ°æœ€è¿‘çš„ä¸€å¤©
        const sortedDates = data.map(d => d.date).sort();
        const lastRecordDate = sortedDates[sortedDates.length - 1]; 
        // æ›´ä¸¥è°¨çš„é€»è¾‘åº”è¯¥åˆ¤æ–­â€œè¿ç»­æ—¥æœŸçš„ç¬¬ä¸€å¤©â€ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼šå‡è®¾æœ€è¿‘è®°å½•æ—¥æœŸçš„æ›´æ—© (CycleLen) å¤©å‰æ²¡æœ‰è®°å½•ï¼Œåˆ™è§†ä¸ºæ–°å‘¨æœŸèµ·ç‚¹
        
        // é¢„æµ‹ä¸‹ä¸€æ¬¡å¼€å§‹æ—¶é—´ = æœ€è¿‘è®°å½• + (å‰©ä½™å¤©æ•°?) 
        // ç®€åŒ–é¢„æµ‹ï¼šæ‰¾åˆ°â€œä¸Šä¸€ä¸ªå‘¨æœŸçš„å¼€å§‹æ—¥â€ï¼ŒåŠ ä¸Š cycleLen
        
        // å¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªâ€œç»æœŸé¦–æ—¥â€ï¼šå³å‰ä¸€å¤©æ²¡æœ‰ç»æœŸè®°å½•
        let lastStartDate = null;
        for (let i = sortedDates.length - 1; i >= 0; i--) {
            const curr = new Date(sortedDates[i]);
            const prev = new Date(curr);
            prev.setDate(prev.getDate() - 1);
            const prevStr = prev.toISOString().split('T')[0];
            if (!data.find(d => d.date === prevStr)) {
                lastStartDate = sortedDates[i];
                break;
            }
        }
        
        if (!lastStartDate) lastStartDate = sortedDates[sortedDates.length - 1]; // Fallback

        const lastStartObj = new Date(lastStartDate);
        const nextStartObj = new Date(lastStartObj);
        nextStartObj.setDate(nextStartObj.getDate() + settings.cycleLen);
        
        const nextStartStr = nextStartObj.toISOString().split('T')[0];

        // ç”Ÿæˆé¢„æµ‹çš„5å¤©ç»æœŸ
        let predictedDays = [];
        for(let i=0; i<settings.periodLen; i++) {
            let d = new Date(nextStartObj);
            d.setDate(d.getDate() + i);
            predictedDays.push(d.toISOString().split('T')[0]);
        }

        // ç”Ÿæˆæ’åµæ—¥ (ä¸‹æ¬¡ç»æœŸå‰14å¤©)
        let ovulationObj = new Date(nextStartObj);
        ovulationObj.setDate(ovulationObj.getDate() - 14);
        const ovulationStr = ovulationObj.toISOString().split('T')[0];

        return { nextPeriod: nextStartStr, predictedDays, ovulationDate: ovulationStr };
    }

    function renderPeriodUI() {
        const data = getPeriodData();
        const settings = getPeriodSettings();
        const today = getTodayStr();

        // 1. æ›´æ–°è®¾ç½®è¾“å…¥æ¡†
        document.getElementById('setting-cycle-len').value = settings.cycleLen;
        document.getElementById('setting-period-len').value = settings.periodLen;

        // 2. è®¡ç®—é¢„æµ‹
        const prediction = calculateCyclePredictions(data, settings);
        
        // 3. æ›´æ–°ä»ªè¡¨ç›˜
        const circleMain = document.getElementById('cycle-main-text');
        const circleSub = document.getElementById('cycle-sub-text');
        const circle = document.getElementById('cycle-circle');
        const btnText = document.getElementById('period-action-btn-text');
        const nextDateText = document.getElementById('next-period-date');

        const isPeriodToday = data.find(d => d.date === today);

        if (isPeriodToday) {
            circleMain.innerText = "ç»æœŸä¸­";
            circleSub.innerText = "æ³¨æ„ä¿æš–";
            circle.classList.add('active');
            btnText.innerText = "ç»æœŸç»“æŸ"; // æŒ‰é’®å˜ä¸ºç»“æŸ
        } else {
            circle.classList.remove('active');
            btnText.innerText = "å¤§å§¨å¦ˆæ¥äº†";
            
            if (prediction.nextPeriod) {
                const todayObj = new Date(today);
                const nextObj = new Date(prediction.nextPeriod);
                const diffTime = nextObj - todayObj;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 0) {
                    circleMain.innerText = diffDays;
                    circleSub.innerText = "å¤©åæ˜¯å¤§å§¨å¦ˆ";
                } else {
                    circleMain.innerText = Math.abs(diffDays);
                    circleSub.innerText = "å¤©(æ¨è¿Ÿä¸­)";
                }
                const nd = new Date(prediction.nextPeriod);
                nextDateText.innerText = `${nd.getMonth()+1}æœˆ${nd.getDate()}æ—¥`;
            } else {
                circleMain.innerText = "--";
                circleSub.innerText = "ç­‰å¾…æ›´å¤šæ•°æ®";
                nextDateText.innerText = "--æœˆ--æ—¥";
            }
        }

        // 4. æ¸²æŸ“æ—¥å†
        const year = periodViewDate.getFullYear();
        const month = periodViewDate.getMonth();
        document.getElementById('period-cal-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        const grid = document.getElementById('period-cal-grid');
        grid.innerHTML = '';
        
        // è®¡ç®—å½“æœˆå¤©æ•°å’Œé¦–æ—¥æ˜ŸæœŸ
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay(); // 0=å‘¨æ—¥
        
        // å¡«å……ç©ºç™½
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div');
            cell.className = 'cal-cell';
            cell.innerText = d;
            cell.onclick = () => togglePeriodDate(dateStr);

            if (dateStr === today) cell.classList.add('today');

            // æ¸²æŸ“çŠ¶æ€
            if (data.find(x => x.date === dateStr)) {
                cell.classList.add('period-flow'); // å®é™…è®°å½•ï¼šå®å¿ƒç²‰
            } else if (prediction.predictedDays.includes(dateStr)) {
                cell.classList.add('period-predicted'); // é¢„æµ‹è®°å½•ï¼šç©ºå¿ƒç²‰
            } else if (dateStr === prediction.ovulationDate) {
                cell.classList.add('period-ovulation'); // æ’åµæ—¥ï¼šç´«
            }

            grid.appendChild(cell);
        }
    }

    // åˆå§‹åŒ–åŠ è½½
    renderSleepUI();
    renderPoopUI();
    renderPeriodUI();

</script>
</body>
</html>
